name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  build-windows-bundle:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Build JAR
        run: |
          .\mvnw.cmd clean package -q
          echo "JAR built successfully"

      - name: Create minimal JRE with jlink
        run: |
          $javaHome = $env:JAVA_HOME
          $jlinkPath = Join-Path $javaHome "bin\jlink.exe"

          # Create minimal JRE with required modules
          & $jlinkPath `
            --add-modules java.base,java.net.http,java.logging,jdk.crypto.ec `
            --strip-debug `
            --no-man-pages `
            --no-header-files `
            --compress=zip-6 `
            --output jre

          echo "Minimal JRE created"
          Get-ChildItem jre -Recurse | Measure-Object -Property Length -Sum | ForEach-Object { "JRE size: $([math]::Round($_.Sum / 1MB, 2)) MB" }

      - name: Create bundle
        run: |
          # Create bundle directory
          New-Item -ItemType Directory -Force -Path bundle\uaxd-mcp

          # Copy JRE
          Copy-Item -Recurse jre bundle\uaxd-mcp\

          # Copy JAR
          Copy-Item target\uaxd-mcp.jar bundle\uaxd-mcp\

          # Create launcher script
          @"
          @echo off
          "%~dp0jre\bin\java.exe" --enable-preview -jar "%~dp0uaxd-mcp.jar" %*
          "@ | Out-File -Encoding ASCII bundle\uaxd-mcp\uaxd-mcp.cmd

          # Create README
          @"
          AS-UAXD MCP Server for Claude Desktop
          ======================================

          This bundle contains:
          - Minimal Java 25 runtime (jre/)
          - UAXD MCP Server JAR (uaxd-mcp.jar)
          - Launcher script (uaxd-mcp.cmd)

          Installation:
          Run install.ps1 or manually add to Claude Desktop config.

          Tools available:
          - GetUAXDArticles (requires VPN)
          - GetASArticles (requires VPN)
          - GetRexArticles (no VPN needed)

          For more info: https://github.com/wiley/as-uaxd-mcp
          "@ | Out-File -Encoding UTF8 bundle\uaxd-mcp\README.txt

          echo "Bundle created"

      - name: Create ZIP
        run: |
          Compress-Archive -Path bundle\uaxd-mcp -DestinationPath uaxd-mcp-windows-x64.zip
          Get-Item uaxd-mcp-windows-x64.zip | ForEach-Object { "Bundle size: $([math]::Round($_.Length / 1MB, 2)) MB" }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle
          path: uaxd-mcp-windows-x64.zip

  create-release:
    needs: build-windows-bundle
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows bundle
        uses: actions/download-artifact@v4
        with:
          name: windows-bundle

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: AS-UAXD MCP v${{ steps.version.outputs.version }}
          body: |
            ## AS-UAXD MCP Server v${{ steps.version.outputs.version }}

            ### Installation (Windows - No Admin Required)

            **One-liner install:**
            ```powershell
            irm https://raw.githubusercontent.com/wiley/as-uaxd-mcp/main/install.ps1 | iex
            ```

            Or with execution policy bypass:
            ```powershell
            powershell -ExecutionPolicy Bypass -Command "irm https://raw.githubusercontent.com/wiley/as-uaxd-mcp/main/install.ps1 | iex"
            ```

            ### What's Included

            - `uaxd-mcp-windows-x64.zip` - Complete bundle with:
              - Minimal Java 25 runtime (~50MB)
              - Pre-built MCP server JAR
              - Windows launcher script

            ### Available Tools

            | Tool | VPN Required |
            |------|--------------|
            | GetUAXDArticles | Yes |
            | GetASArticles | Yes |
            | GetRexArticles | No |

          files: |
            uaxd-mcp-windows-x64.zip
            install.ps1
          draft: false
          prerelease: false
